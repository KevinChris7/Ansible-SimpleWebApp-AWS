# aws-ec2.yml

---
  - name: Creates the ec2 instances
    hosts: webservers
    #connection: local
    gather_facts: no
    roles:
      - python
    tasks:  
      - name: Launch an EC2 Instance
        ec2_instance: 
          aws_access_key: "{{ AWS_ACCESS_KEY }}"
          aws_secret_key: "{{ AWS_SECRET_ACCESS_KEY }}"
          name: "{{ item }}"
          image_id: "{{ image_id }}"
          instance_type: "{{ instance_type }}"
          key_name: "{{ key_pair }}"
          region: "{{ aws_region }}"
          security_group: "{{ security_group }}"
          state: present
          wait: true
        register: ec2_instance
        loop: "{{ instance_list }}"
      - name: Gather EC2 info
        ec2_instance_info: 
          aws_access_key: "{{ AWS_ACCESS_KEY }}"
          aws_secret_key: "{{ AWS_SECRET_ACCESS_KEY }}"
          region: "{{ aws_region }}"
          filters:
            "tag:Name": "{{ instance_list }}"

      - name: Wait for SSH connection
        wait_for: host={{ec2_instance[0].public_dns_name}} port=22 timeout=240
        with_items: "{{ ec2_instance.instances }}"  #"{{ec2_instance.instances.public_ip_address}}"   #Need to check
      
      # - name: Add hosts to webservers
      #   add_host: hostname= {{item.public_ip_address}} ansible_ssh_port= {{item.port}} groupname= web_servers
      #   loop: "{{ec2.instances[0]}}"

      - name: Add hosts to dbservers
        add_host: hostname= {{item.public_ip_address}} ansible_ssh_port= {{item.port}} groupname= db_servers
        loop: "{{ec2_instance.instances[1]}}"

        
